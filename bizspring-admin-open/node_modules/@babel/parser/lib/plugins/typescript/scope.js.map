{"version":3,"names":["_scope","require","_scopeflags","_parseError","TypeScriptScope","Scope","constructor","args","types","Set","enums","constEnums","classes","exportOnlyBindings","TypeScriptScopeHandler","ScopeHandler","importsStack","createScope","flags","push","enter","ScopeFlag","TS_MODULE","exit","pop","hasImport","name","allowShadow","len","length","has","i","declareName","bindingType","loc","BindingFlag","FLAG_TS_IMPORT","parser","raise","Errors","VarRedeclaration","at","identifierName","add","scope","currentScope","FLAG_TS_EXPORT_ONLY","maybeExportDefined","KIND_TYPE","KIND_VALUE","checkRedeclarationInScope","FLAG_TS_ENUM","FLAG_TS_CONST_ENUM","FLAG_CLASS","isRedeclaredInScope","isConst","wasConst","lexical","checkLocalExport","id","scopeStack","exports","default"],"sources":["../../../src/plugins/typescript/scope.ts"],"sourcesContent":["import type { Position } from \"../../util/location\";\nimport ScopeHandler, { Scope } from \"../../util/scope\";\nimport {\n  BindingFlag,\n  ScopeFlag,\n  type BindingTypes,\n} from \"../../util/scopeflags\";\nimport type * as N from \"../../types\";\nimport { Errors } from \"../../parse-error\";\n\nclass TypeScriptScope extends Scope {\n  types: Set<string> = new Set();\n\n  // enums (which are also in .types)\n  enums: Set<string> = new Set();\n\n  // const enums (which are also in .enums and .types)\n  constEnums: Set<string> = new Set();\n\n  // classes (which are also in .lexical) and interface (which are also in .types)\n  classes: Set<string> = new Set();\n\n  // namespaces and ambient functions (or classes) are too difficult to track,\n  // especially without type analysis.\n  // We need to track them anyway, to avoid \"X is not defined\" errors\n  // when exporting them.\n  exportOnlyBindings: Set<string> = new Set();\n}\n\n// See https://github.com/babel/babel/pull/9766#discussion_r268920730 for an\n// explanation of how typescript handles scope.\n\nexport default class TypeScriptScopeHandler extends ScopeHandler<TypeScriptScope> {\n  importsStack: Set<string>[] = [];\n\n  createScope(flags: ScopeFlag): TypeScriptScope {\n    this.importsStack.push(new Set()); // Always keep the top-level scope for export checks.\n\n    return new TypeScriptScope(flags);\n  }\n\n  enter(flags: ScopeFlag): void {\n    if (flags == ScopeFlag.TS_MODULE) {\n      this.importsStack.push(new Set());\n    }\n\n    super.enter(flags);\n  }\n\n  exit() {\n    const flags = super.exit();\n\n    if (flags == ScopeFlag.TS_MODULE) {\n      this.importsStack.pop();\n    }\n\n    return flags;\n  }\n\n  hasImport(name: string, allowShadow?: boolean) {\n    const len = this.importsStack.length;\n    if (this.importsStack[len - 1].has(name)) {\n      return true;\n    }\n    if (!allowShadow && len > 1) {\n      for (let i = 0; i < len - 1; i++) {\n        if (this.importsStack[i].has(name)) return true;\n      }\n    }\n    return false;\n  }\n\n  declareName(name: string, bindingType: BindingTypes, loc: Position) {\n    if (bindingType & BindingFlag.FLAG_TS_IMPORT) {\n      if (this.hasImport(name, true)) {\n        this.parser.raise(Errors.VarRedeclaration, {\n          at: loc,\n          identifierName: name,\n        });\n      }\n      this.importsStack[this.importsStack.length - 1].add(name);\n      return;\n    }\n\n    const scope = this.currentScope();\n    if (bindingType & BindingFlag.FLAG_TS_EXPORT_ONLY) {\n      this.maybeExportDefined(scope, name);\n      scope.exportOnlyBindings.add(name);\n      return;\n    }\n\n    super.declareName(name, bindingType, loc);\n\n    if (bindingType & BindingFlag.KIND_TYPE) {\n      if (!(bindingType & BindingFlag.KIND_VALUE)) {\n        // \"Value\" bindings have already been registered by the superclass.\n        this.checkRedeclarationInScope(scope, name, bindingType, loc);\n        this.maybeExportDefined(scope, name);\n      }\n      scope.types.add(name);\n    }\n    if (bindingType & BindingFlag.FLAG_TS_ENUM) scope.enums.add(name);\n    if (bindingType & BindingFlag.FLAG_TS_CONST_ENUM) {\n      scope.constEnums.add(name);\n    }\n    if (bindingType & BindingFlag.FLAG_CLASS) scope.classes.add(name);\n  }\n\n  isRedeclaredInScope(\n    scope: TypeScriptScope,\n    name: string,\n    bindingType: BindingTypes,\n  ): boolean {\n    if (scope.enums.has(name)) {\n      if (bindingType & BindingFlag.FLAG_TS_ENUM) {\n        // Enums can be merged with other enums if they are both\n        //  const or both non-const.\n        const isConst = !!(bindingType & BindingFlag.FLAG_TS_CONST_ENUM);\n        const wasConst = scope.constEnums.has(name);\n        return isConst !== wasConst;\n      }\n      return true;\n    }\n    if (bindingType & BindingFlag.FLAG_CLASS && scope.classes.has(name)) {\n      if (scope.lexical.has(name)) {\n        // Classes can be merged with interfaces\n        return !!(bindingType & BindingFlag.KIND_VALUE);\n      } else {\n        // Interface can be merged with other classes or interfaces\n        return false;\n      }\n    }\n    if (bindingType & BindingFlag.KIND_TYPE && scope.types.has(name)) {\n      return true;\n    }\n\n    return super.isRedeclaredInScope(scope, name, bindingType);\n  }\n\n  checkLocalExport(id: N.Identifier) {\n    const { name } = id;\n\n    if (this.hasImport(name)) return;\n\n    const len = this.scopeStack.length;\n    for (let i = len - 1; i >= 0; i--) {\n      const scope = this.scopeStack[i];\n      if (scope.types.has(name) || scope.exportOnlyBindings.has(name)) return;\n    }\n\n    super.checkLocalExport(id);\n  }\n}\n"],"mappings":"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"}